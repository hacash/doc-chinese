HACD 接入交易所的补充说明
===

>
> 阅读本文档之前，需要先查阅 Hacash 全节点的 [RPC API 接口文档](https://github.com/hacash/doc-chinese/blob/main/service/rpc_api_doc.md) ，以作为技术理解的基础。
>

HACD（也称钻石） 是一种 NFT（非同质化代币），但可以像 FT（同质化代币） 一样在交易所随意分割和交易，且完全适配为普通区块链上的 FT 代币所研发的充值、提现和买卖的交易所程序，只需要做一点点额外开发（多查询一两个接口）。本文档将详细说明交易所或其它第三方平台在接入 HACD 时的概念理解和注意事项。

本文档假设开发者已经了解了 Hacash 的接口文档，并且知晓如何通过 RPC 接口完成例如新账户创建、HAC转账或区块交易扫描等通常的对接开发工作，只是在 HACD 的对接上遇到了一些概念上或技术上的阻碍。


## 基础理解

Hacash 链上有三种原生 PoW 货币：HAC、BTC 和 HACD。其中，HAC 和 BTC 是 FT（同质化）， 而 HACD 是 NFT（非同质化），以不可分割的 枚 为单位，其在 Hacash 链上的转账也是必须以整数 枚 为单位，不支持转 0.1 或者 2.5 这种带有小数的数量。

HACD 用不重复六位字母作为唯一标记，称之为字面值或钻石名称，从 `WTYUIAHXVMEKBSZN` 这16个字符中随机组合，其最大总量为 16 ^ 6 = 16777216 枚。每一枚都是独一无二且不可分割的。

在 Hacash 区块链上，与通常的 FT 代币（例如HAC）直接采用数字的转账方法不同，HACD 的转账必须通过字面值列表来进行，也就是逗号隔开的6位字母列表，例如 `WTYUIA` 或者 `AHXVME,KBSTZN` 等字符串的形式，这样才能精确的转移 HACD 这种 NFT 的所属权，类似以太坊的以数字编号来转移 NFT 一样。

HACD 将在其区块链的状态数据中，保存一个所属者的地址，用于记录 HACD 的所属权。


## 技术对接

#### 充值

普通FT代币转账或充值近交易所时，只会单纯体现为一个数字代表的代币数额的转移，而 HACD 的充值无法仅用一个数字来达成，必须带有完整的字面值列表，以便区块链系统能准确无误地变更这些 NFT 的所属权。交易所在扫描区块交易时，将会从 HACD 的充值交易里获取到一个 `diamond` 的字段，这是一个字符串值，是充入交易所地址的 HACD 名称列表，之间用逗号隔开，例如 `WTYUIA` 或者 `AHXVME,KBSTZN,WTYUIA` 。

此时，通过使用 split 函数解析这个字符串，就可以得到充入交易所的 HACD 名称列表，以及数量。然后，与FT充值相同，在经过若干个区块的确认次数之后，将充入的 HACD 数量增加到客户的余额表内，充值完成。

>【额外开发一】：交易所需要另外记录这些充值的 HACD 名称，维护一个交易所拥有的全部 HACD 的字面值列表，或者对应地址上拥有的 HACD 列表，以便后续转账或提现使用。


#### 交易

在将充值数量增加到客户的账户余额中之后，在交易所内部的交易则与 FT 无任何区别，并可随意分割，支持小数方式交易，例如在订单簿内挂单 0.1 、0.003 或者 12.57 等数量来买卖。

经过交易之后，客户的 HACD 账户余额也可支持小数，例如 127.38 枚 HACD。

#### 提现

由于 HACD 在 Hacash 链上只能以整数枚的方式进行转账，所以客户在提现 HACD 时，也只支持整数，不支持小数。最低一枚，最多两百枚。

所以，当客户的 HACD 余额小于一枚时，无法进行提现操作。必须在客户买入累积为至少一枚 HACD 时，才可提现。

当客户申请提现时，无法直接简单通过一个数字来转账，必须从交易所内部维护的 HACD 名称列表内，随机取出对应提现数量的字面值，然后用这些取出的名称构造 HACD 的转账交易，将特定的 HACD 提取给客户。

>【额外开发二】：提现时从记录的交易所拥有的全部 HACD 列表里随机取出对应数量的字面值，转账给客户，并将这些字面值从交易所的总余额列表里移除。（不可转账已经被转给其他账户钻石名称）

#### 账户归集和冷钱包维护

无论是交易所为每个客户单独生成的充值地址，还是归集钱包和冷钱包地址，都没有参与 HACD 的挖矿和抵押等，其每个地址所拥有的 HACD 余额和名称列表，都可以从扫描的区块转账记录中解析和构建出来（六位字面列表的增加或移除）。

当需要归集客户的充值到热钱包，或者需要从热钱包转移进冷钱包之时，都可以从交易所内部维护的每个地址及其拥有的 HACD 字面值列表中构建转账交易而提取。

当手动从冷钱包提取 HACD 到热钱包时，可以去 [区块链浏览器](https://explorer.hacash.org/) 查看冷钱包地址内的 HACD 名称列表，然后手动发起转账。

> 【便捷接口】如果这种归集和冷热维护需要程序自动化，那么全节点提供了一个查询单个地址所拥有的钻石字面值的接口： [https://github.com/hacash/doc-chinese/blob/main/server/fullnode_api_doc.md#31-%E6%9F%A5%E8%AF%A2%E8%B4%A6%E6%88%B7%E4%BD%99%E9%A2%9D--get-querybalance](ttps://github.com/hacash/doc-chinese/blob/main/server/fullnode_api_doc.md#31-%E6%9F%A5%E8%AF%A2%E8%B4%A6%E6%88%B7%E4%BD%99%E9%A2%9D--get-querybalance) 
> 需要全节点配置开启 `[server]` 下的 `diamond_form = true` 字段

返回值如下：

```js
{
    list: [
        {   /* ... other ... */
            diamonds: "KEATNHZVHIVYTBSVUWEUBUUWHZNVMIHNWSVUWUXNXVASYXTVTNSBHBUWMYUM",
        }
    ]
    ret: 0,
}
```

> 【提示一】由于一个地址下可能存在几千上万枚钻石，为了压缩数据量以最大化接口访问效率，名称列表并没有采用逗号隔开，而是按6位直接拼接起来，切分处理时字符串索引直接 `i += 6` 迭代即可。
>
> 【提示二】本接口返回的是经过 4 个区块确认后的数据。也就是说，以此获得 HACD 列表，内容将滞后 4 个区块，无论是转入还是转出。已经计划在将来的全节点版本中直接支持访问地址下的钻石列表。


## 其它注意事项

1. Hacash 系统内限制了每次 HACD 转账最多 200 枚，所以无论是用户充值，还是提现，每次最多 200。 但交易所内部的订单簿不受此限制。

2. 使用 explorer 区块浏览器的接口只是暂时的权益之计，建议交易所直接通过扫描交易来维护自己的 HACD 字面值列表。此第三方接口未来将可能更改或者**不再可用**。

3. 构建 HACD 转账交易时，可以使用另外一个地址作为链上 Gas 费支出账户，不需要同时拥有 HAC 就能将 HACD 转出。交易所可以用热钱包或者专门的 Gas 费账户来支付所有 HACD 转账的 Gas 费。



