Hacash 交易广播和交易池操作重要事项
===


> 提示：交易所或钱包等需要向 Hacash 区块链提交交易的各类第三方服务，都应该详细阅读本文档，并依照给出的措施来设计系统，否则将有可能造成交易丢失、重复转账等严重资产安全问题

和比特币一样，Hacash 主网按照 [稳定和精简的设计原则](https://github.com/hacash/doc-chinese/blob/main/tech/bitcoin_and_hacash_L1_comparison.md) 来设计整个系统，将所有不必要放在主网的功能剥离并置于外层，尽可能保持区块链核心的简单。其中，Hacash 的交易池的设计也严格遵循了这一原则，我们将描述交易池的设计，并给出在广播异常、主网拥堵等情况下的处理办法。

### 设计说明

#### 1. Block confirmation

Hacash's unique anti-51% attack technology [Beacon Tower Protocol](https://github.com/hacash/paper/blob/master/HIP/protocol/tech/PoW_of_avoid_51_percent_attack.md) protects the blockchain from malicious attacks.

In addition to analyzing and blocking malicious hashrate attacks, this protocol also stipulates the Hacash blockchain fork checkpoint: 4 blocks. This means that transactions that are highly confirmed by 4 or more blocks are secure and non-reversible, but, transactions that are less than 4 block of confirmation may be reversed.

> It is recommended that exchanges set a waiting (final confirmation) time of 4 blocks for large deposits, otherwise they may be exploited maliciously

#### 2. Transaction pools

Hacash 的交易池是一个具有最大容量的内存池（Memtxpool），选择这一实现方案基于以下原因：

- 设置最大容量，将降低设备的存储负担，以支持普通个人电脑甚至嵌入式设备运行全节点
- 仅在内存中处理交易的性能更高，可以支持更频繁的交易插入和排序，以支持交易手续费的动态报价
- 仅内存数据结构的设计实现足够简单，可以支持不同的全节点、轻节点等类型选择各自独特的实现，以支持更多种类的设备
- 考虑到现代矿业条件下的区块生产大多来自于专业矿池，它们有足够的开发资源、并且通常都会自己定制独立的交易池系统，所以由区块链主网核心来提供一个复杂、庞大的交易池实现是根本不必要甚至有坏处的
- 大部分区块由更长期稳定在线的专业矿池来生产，则交易在普通全节点设备上的硬盘储存便会是一种多余行为
- Hacash 并不追求 L1 的所谓高性能，区块间隔时间为 5 分钟，有充足的时间处理创建、广播和修改交易的操作，并且主网的分叉、宕机或回退等异常情况出现的可能性非常低，不必要长期在硬盘中保存交易来作为应对措施
- 将未确认交易的维护责任推至外层用户端，有利于在出现极端情况时的区块链状态恢复
- 就算实现了硬盘持久化保存未确认交易队列，这个“硬盘交易池”的空间还是有限的，不可能无限大，这时同样需要处理未确认交易过多的情况，超出容量限制的交易仍然只能被丢弃，并没有解决问题

这意味着，在以下两种情况出现时，已经加入交易池内的交易，在没被区块打包确认之前，可能会被从内存池中移除，并且不会自动再次加入内存池：

- 其它关联交易被先行打包，导致此交易出现余额不足等错误，被移出了交易池
- 设置手续费过低，排列在内存池末尾，当未确认交易过多时，被挤出了内存池

这意味着一些特殊情况出现时，外层（用户端）将承担更大的、与自己相关的未确认交易维护的责任，不能完全依赖 Hacash 全节点，无法将交易简单广播出去了事。如果不保存交易并尝试再次提交，将可能导致转账失败。

而在内存池已满（区块链拥堵）的情况下，手续费过低的交易将无法进入全节点的未确认交易队列。

### 应对措施

考虑到 Hacash 的分层扩容机制，主网交易将在未来面临更高的手续费支出，并且交易池将可能持续处于填满状态。手续费设置过低的交易将长期得不到区块链的打包确认，并且可能被挤出交易池。第三方开发者需要通过以下策略来应对这种情况：

- 不能仅仅保存交易哈希（TxID 或者 TxHash），创建的交易体（TxBody）也需要持久化保存一段时间（比如一周或者一个月），直到交易被区块链打包确认一段时间之后
- 如果交易长时间（4个区块以上）未被打包确认，需要再次向全节点广播这笔交易，以应对交易可能被挤出交易池的问题
- 可以直接在提现日志等地方向用户展示完整的 TxBody ，由用户自己再次去钱包里提交交易（在全网手续费已经降低、区块链未拥堵的时候可行）

> 警告：如果不保存已经创建的交易体（TxBody），而是在交易被挤出交易池后又再次通过新的时间戳创建一笔新的交易广播的话，有可能出现新、旧两笔交易都被打包确认的情况（有可能其它第三方交易池仍然保存了这笔交易，并在全网手续费降低时这意味着交易所对一笔提现操作进行了两次转账，资产将因为重复支出而受到损失）
>
> 但如果采用相同的时间戳、地址、数额等创建的交易，仅手续费不同，则会被 Hacash 区块链视为相同的交易，只会有手续费最高的那一笔会上链确认，后文有述

如果交易无法加入全节点的交易池（一般为余额不足或者手续费设置过低），或加入后一直得不到打包确认，甚至被从交易池内挤出，有两种办法应对：

- 等待全网手续费降低后再次提交交易
- 修改交易，设置更高的手续费后再次提交交易

Hacash 支持修改已经提交到交易池内的交易的手续费数额，或者以更高的手续费再次提交交易。我们将描述这个设计并给出相关接口。

### 相关接口

Hacash 的交易通过转账数额、收款地址、时间戳等交易体（TxBody）内容来计算出唯一的TxHash（也称为TxID），两笔转账的地址、数额和时间戳一样，就意味着这是同一笔交易，只能在区块链内执行一次。但交易的手续费数额（Fee字段）并不包含在这笔交易的唯一标识符之内，如果签署了多笔仅仅手续费不同的交易，最终也只能有唯一一笔交易进入区块链内得到确认。

同时交易可以由多方签署，TxHash（或者TxID）分为两种，一种是手续费地址（或者叫主地址）签署的 Hash 称为 FeeHash，包含了这笔交易设置的手续费数额，另一种是供其他地址签名的 Hash 称为 CommonHash，不包含手续费数量。而区块链以 CommonHash 为交易识别的唯一标识符。这意味着可以自由对这笔交易的手续费进行设置和修改，而不需要其他相关方再次签名，只需要手续费地址再度签名并广播交易即可。

如果你需要修改（一般来说就是增加）已经广播但得不到确认的交易的手续费，除了重新以相同的时间戳、转账数额和地址等信息再次构造这笔交易、设置更高的手续费，然后签名交易并再次广播以外，Hacash 全节点有一个接口可以直接通过 TxHash、Fee 和 PrivateKey 来重设交易手续费并自动广播：

- [https://github.com/hacash/doc-chinese/blob/main/service/rpc_api_doc.md#4-operate-修改操作](https://github.com/hacash/doc-chinese/blob/main/service/rpc_api_doc.md#4-operate-%E4%BF%AE%E6%94%B9%E6%93%8D%E4%BD%9C)

> 注意一：当交易已经被从交易池中挤出（移除）之后，需要再次提交这笔交易的 TxBody，才能实现修改手续费并再次广播
> 
> 注意二：这个接口只能增加交易的手续费，而无法降低（在全网交易拥堵时降低手续费设置是无意义的）

