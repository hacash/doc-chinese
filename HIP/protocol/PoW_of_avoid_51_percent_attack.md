HIP-7: 防51%算力攻击的 PoW 共识机制（烽火台协议）
===

众所周知，51%算力攻击（简称51攻击）是 PoW 共识协议的主要缺陷。现代金融货币系统所要求的大规模和稳定性无法容忍此类严重系统性缺陷所造成的潜在巨大财务风险，从而极大地阻碍了人类向更加公平和高效的加密货币和加密金融体系迁移的步伐。我们亟待一种能避免此种缺陷又不丢失任何 PoW 机制根本好处的共识协议改良方案。

这样的优化方案并非不可能。原因是比特币最早发明的“最长链原则”仅是一种原始、粗简的初级方案，由于缺乏实践经验上的资料和佐证，欠缺全面和完善的考虑，从而不可避免地造成了这样的问题。如今十多年过去了，我们可以在足够多的理论尝试和实践经验支持下，找到更妥善健全的办法。

Hacash 的白皮书中已经提出一种名为“历史见证防51%攻击”的解决方案，描述了其理论和大致方式，但并没有给出详细的实现细节。本提案将遵循和延展白皮书的既有内容，详细分析这一攻击型缺陷的细节和后果，提出更加具体且分多个层次的解决方案，并说明其注意事项和潜在代价。

### 攻击原理分析

51%攻击是阻碍加密货币大规模普及使用的最大阻碍之一。特别是对于一些算力规模较小的新创加密货币来说，潜在的攻击风险会将机制设计更公平高效的新货币扼杀在摇篮中，市场从而被先发优势所统治，我们不得不长期忍受差强人意的古老货币，无法充分竞争和自由选择出最优质的加密货币。

此种算力攻击的原理是：一个（或数量极小）的矿工，悄悄运用高于其它所有矿工加总的算力，私下计算一条更长的链条，但并不公布这链，不让任何人知晓。一段时间后（比如几个区块后）突然将更长的链条广播给全网，由于共识协议的“最长链原则”，导致大家被迫放弃已经公认的链条，转到攻击者的分叉上来，从而让攻击者可以撤回被认为已经生效的交易（双花）。攻击表现为已经挖出的区块链条失效回退了，相关交易也被迫撤销。

也就是说，51%攻击本质上是篡改历史：运用更大的算力篡改已被大家公认的区块历史。

对于矿工来说，之前判断自己正在挖的区块链条是否有效，仅仅取决于是否为最长链。但问题是，由于PoW的开放准入和链外成本体系，全网的算力规模随时发生变化，在某一刻无法100%确定是否有私下的分叉链条正在被悄悄挖掘。当前链是否为最长链是一个根本就不能确定的盲盒问题，这导致PoW共识永远无法达成“终局”，始终面临随时被回退的风险。比特币并没有解决这个问题，而是寄希望于总算力规模达到非常高的程度，以至于没有任何攻击者能掌握超过51%的算力，从而从经济上阻止此种攻击的发生。但这对于其它规模更小的竞争币特别是初创项目来说并不现实。

### 解决路径

攻击有效的前提是，全网占绝大多数的全节点都放弃了广泛广播且已经公认的链条，被迫认可了攻击者悄悄私下挖掘且一段时间后才突然提交的最长链，撤销了已经被视为有效且执行了的区块和包含的交易。

攻击者和诚实矿工的唯一区别为是否将新挖出的区块立刻、及时地广播给全网。如果没有人隐瞒新挖出的区块，就不存在攻击。那么问题的关键在于，如何让从利益或惩罚机制上迫使大家及时广播区块，或者设计一种识别机制或链条选择协议，让被隐瞒的区块不被大家所认可。

这意味着我们必须放弃深入人心的“最长链原则”，取而代之的是“公布最广链原则”。

将有效链条的判断权力从矿工那里下发给全网的全节点。矿工挖出区块并广播，全网节点实时监督且共同判断挖出的区块是否进行了及时且广泛的公布。

幸好，与“最长链”不同的是，“公布最广链”是一个可以通过某种通信或协议去达成“终局”的判断规则。我们只要设计出一种让绝大多数诚实节点可以达成共识的协议，确定无疑的共同选择出最广泛广播的“最广链”，而一致抵制个别攻击者提交的“最长链”。潜在攻击者预期到私下挖掘的链条不会被全网多数人认可，那么这种攻击也就不会发生。也就是说，我们可以通过“链下通信合作”这种社会性合作来辅助共识协议的有效运转，而不是将全部希望完全依赖于代码。

当然，这种解决方案也并非完美，它立足于某些基础性的前提和假设，并且也带来了某些另外的代价或者更高的运行要求，我们将在后文进行详细分析。但无论如何，相比于被双花攻击的重大核心风险，为此付出一些成本是必须且完全值得的，天下没有免费的午餐。

### 第一层解决方案

Hacash 的目标区块间隔时间为大约5分钟。但由于 X16RS 挖矿算法的强随机特性，时常出现前后相隔十几秒就挖出下一个区块的情况。由于区块有效性验证和广播都需要时间，偶尔会发生两个矿工几乎同时挖出下一个区块的情况，这时全网将收到两个有效区块，且各自有一半的全节点先收到其中一个区块，这造成了事实上的临时区块分叉。

假设按区块间隔时间平均5分钟即300秒计算，在同一秒挖出两个有效区块的概率为 1/300 ，则得出如果四个连续区块都同时被挖出的概率平均为 (1/300)^4 约等于 0.00000000012345679，概率小于一百亿分之一意味着接近 10000 年才会出现一次，这足够安全了。

4个区块被挖出平均耗时20分钟，而广播一个填满交易的区块至全世界，正常情况一般只需要几秒钟。一个积极且诚实的矿工无论如何也不需要20分钟的时间来广播新挖出的区块。

所以，第一个方案即加上长度为 4 个区块的确认检查点。全网所有全节点都不接受 4 个区块之前的区块链条分叉，默认为这条历史分叉为不诚实的攻击者提交从而拒绝接受。也就是说，一个网络连接保持通畅的全节点，第 4 个区块以前的区块即可视为永久确认不可回退了。

### 第二层解决方案

设置 4 个区块的检查点仍然留下了大约 20 分钟的“可回退时间”，理论上最新的 4 个区块都是不成熟的、未经确认的状态。且此检查点只针对节点本体自身有效，并不能达成全面终局。也就是说，如果某个矿工或某个地理区域长时间断网，且又挖出了4个以上的区块，则4个区块检查点的方案将造成局部的永久分叉，受影响的节点不得不人工判断那一条才是公认的有效链，并手动选择分叉回退区块。但需要注意的是，无论哪种共识方案都无法处理大规模长时间断网的问题，区别的只是后果不同：要么分叉，要么干脆停止出块。

我们提出第二层方案，即让某些被选定的地址或节点为最新挖出的区块进行投票（比如选择21个最近挖出区块的矿工地址为投票人）。有资格投票的地址列表是有限且确定的，则投票的结果如果过半，比如21个最近矿工中有11个地址已经对某一个区块投票，表示收到并认可了这个区块，那么全网就可以认为此区块已经广播给几乎全部节点，达成终局共识，从而不必等待 4 个区块的自动确认。

由于投票的数据比区块小很多，且除了一次私钥签名验证，不需要其它任何计算，投票数据的广播速度将比区块广播快得多，从而基本上只要区块到达全节点便能立即得到投票确认。也就是说，只要投票人积极参与投票，区块的最终确认时间将取决于区块广播的速度，大概就是几秒的时间。

由于投票需要私钥实时在线签名，这会导致安全性的降低。我们可以利用委托投票的方案来解决部分矿工投票积极性不高或者无法保持实时在线的问题，即将投票权委托给某一个大家选出且账户上没有资产的地址。就算地址被盗，不会有任何资产损失，且投票可以照常进行。唯一的后果是可能出现重复投票，这并不是问题。大家可以重新委托一个新的地址。

这些按固定规则选出的投票人我们可以称其为“链上烽火台”，只要多数“烽火台”燃起了烟火（投票），我们即可认为此区块被永久确认，以后广播的相同高度区块都是不诚实的攻击者的作为。

### 第三层解决方案

第二层方案仍然有一个缺陷，那就是当攻击者掌握 51% 算力时，他们可以伪装出多数的新的矿工，并且不参与投票，让区块无法得到即时确认。但这也带来另一个好处，即攻击预警。也就是说，当多数投票人突然间不参与投票时，就意味着网络将可能发生攻击，大家将可以立即为此做好准备。

此时可以引入第三层方案，即“链下烽火台”共识。这些链下投票人并不是按确定规则由算法选定，而是依赖于社区的信任和声望，并且分散在全球各个物理位置。攻击者事后提交的更长链一定会在广播时间上大大晚于诚实的链条，一般会晚几十分钟到几个小时，攻击才会有效。

社区认可的“链下烽火台”将持续记录自己收到的每一个区块和收到的时间。当攻击行为发生，第二层方案无效时，全网节点就可以结合本地的 4 区块确认和这些“社区烽火台”发布的信息，综合判断出那条链是攻击者行为，从而共同抵制。

通过以上三个方案，51%算力攻击者将预期到攻击实施的成功率将会很低，在一个连接保持通畅的网络中，攻击行为将被快速有效识别出来。攻击从而不会发生。

### 问题与代价

以上解决方案虽然能高效的解决问题，杜绝严重的双花攻击导致的财务风险，但也并不100%完美，且提高了某些基础运行条件以及带来了某些后果：

 - 一、对矿工的网络连接质量（稳定性而非速度）提出了更高的要求，矿工不能断网，特别是算力占比较大的矿工，断网会造成事实上的区块链分叉，并更加依赖于人工介入处理。这是由于协议上无法识别那些是诚实而仅仅只是断网了矿工，哪些是恶意偷偷挖矿的攻击者，全都一视同仁视为不怀好意。
 - 第二、整体区块链对大规模物理攻击（如战争）的抵抗能力降低了，全网无法仅仅从技术上判断哪条链才是有效链，而必须依赖于保持对实时信息的跟进判断和社会、社区合作。新参与的节点无法脱离社区实时的信息，仅仅从区块数据本身判定哪条链才是有效的。



